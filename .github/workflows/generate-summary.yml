name: Generate capture summary

on:
  workflow_dispatch:
    inputs:
      capture_id:
        description: 'Capture UUID to summarize'
        required: true

jobs:
  summarize:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: write
    steps:
      - uses: actions/checkout@v4

      - name: Generate markdown summary
        env:
          CLAUDE_API_KEY: ${{ secrets.CLAUDE_API_KEY }}
          CAPTURE_ID: ${{ github.event.inputs.capture_id }}
        run: |
          CAPTURE_FILE="docs/captures/$CAPTURE_ID.json"
          SUMMARY_FILE="docs/summaries/$CAPTURE_ID.md"

          if [ ! -f "$CAPTURE_FILE" ]; then
            echo "Capture file not found: $CAPTURE_FILE"
            exit 1
          fi

          if [ -f "$SUMMARY_FILE" ]; then
            echo "Summary already exists for $CAPTURE_ID, skipping."
            exit 0
          fi

          mkdir -p docs/summaries

          CAPTURE_JSON=$(cat "$CAPTURE_FILE")

          PROMPT="Given this JSON capture of a human/AI development session, write a clear markdown summary.\n\nRules:\n- Start with a single H1: the problem statement (concise, max 80 chars)\n- Second line: a blockquote with the capture date formatted as: > Captured on YYYY-MM-DD\n- Three H2 sections: \"Problem\", \"Solution\", \"Insight\" â€” each followed by one concise paragraph\n- End with a horizontal rule (---) and a markdown link: [Raw capture data](captures/${CAPTURE_ID}.json)\n- Return ONLY the markdown content, no code block wrapping, no extra commentary\n\nCapture:\n${CAPTURE_JSON}"

          PAYLOAD=$(jq -n \
            --arg content "$PROMPT" \
            '{
              model: "claude-haiku-4-5-20251001",
              max_tokens: 1024,
              messages: [{"role": "user", "content": $content}]
            }')

          SUMMARY=$(curl -s https://api.anthropic.com/v1/messages \
            -H "x-api-key: $CLAUDE_API_KEY" \
            -H "anthropic-version: 2023-06-01" \
            -H "content-type: application/json" \
            -d "$PAYLOAD" | jq -r '.content[0].text')

          if [ -z "$SUMMARY" ] || [ "$SUMMARY" = "null" ]; then
            echo "Claude returned an empty response."
            exit 1
          fi

          echo "$SUMMARY" > "$SUMMARY_FILE"
          echo "Summary generated: $SUMMARY_FILE"

      - name: Commit and push summary
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          CAPTURE_ID="${{ github.event.inputs.capture_id }}"
          SUMMARY_FILE="docs/summaries/$CAPTURE_ID.md"

          if [ ! -f "$SUMMARY_FILE" ]; then
            echo "No summary to commit."
            exit 0
          fi

          git config user.name "thinkless-bot"
          git config user.email "bot@thinkless.dev"

          if [ -n "$GH_PAT" ]; then
            git remote set-url origin "https://x-access-token:${GH_PAT}@github.com/${{ github.repository }}.git"
          fi

          git add "$SUMMARY_FILE"
          git commit -m "summary: add $CAPTURE_ID"
          for i in 1 2 3 4 5; do
            git pull --rebase origin main && git push && break
            echo "Push attempt $i failed, retrying..."
            sleep $((i * 2))
          done

          # Dispatch captures page update
          gh workflow run update-captures-page.yml \
            --repo "${{ github.repository }}"
